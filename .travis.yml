services:
  - postgresql
  - docker
matrix:
  include:
    - language: rust
      os: linux
      rust: nightly
      before_install:
        - cd atcoder-problems-backend/
      before_script:
        - psql -c "CREATE USER kenkoooo PASSWORD 'pass';" -U postgres
        - psql -c "CREATE DATABASE test OWNER kenkoooo;" -U postgres
      script:
        - cargo clean
        - cargo build
        - RUST_TEST_THREADS=1 cargo test

    - language: node_js
      node_js: node
      before_script:
        - cd atcoder-problems-frontend
      script:
        - npm install yarn -g
        - yarn
        - yarn build
        - yarn test --coverage
        - npx codecov
        - yarn lint

deploy:
  provider: script
  script:
    - cd atcoder-problems-backend/
    - docker build -t kenkoooo/atcoder-problems-backend .
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker push kenkoooo/atcoder-problems-backend
  on:
    branch: master
